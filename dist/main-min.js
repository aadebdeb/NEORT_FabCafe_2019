!function(e){var t={};function r(n){if(t[n])return t[n].exports;var i=t[n]={i:n,l:!1,exports:{}};return e[n].call(i.exports,i,i.exports,r),i.l=!0,i.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)r.d(n,i,function(t){return e[t]}.bind(null,i));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";r.r(t);var n=function(){function e(e,t,r){this.x=e,this.y=t,this.z=r}return Object.defineProperty(e,"zero",{get:function(){return new e(0,0,0)},enumerable:!0,configurable:!0}),e.prototype.sqMag=function(){return this.x*this.x+this.y*this.y+this.z*this.z},e.prototype.mag=function(){return Math.sqrt(this.sqMag())},e.prototype.norm=function(){var e=this.mag();return this.mul(1/e)},e.prototype.add=function(e){return this.x+=e.x,this.y+=e.y,this.z+=e.z,this},e.prototype.sub=function(e){return this.x-=e.x,this.y-=e.y,this.z-=e.z,this},e.prototype.mul=function(e){return this.x*=e,this.y*=e,this.z*=e,this},e.prototype.mulV=function(e){return this.x*=e.x,this.y*=e.y,this.z*=e.z,this},e.prototype.div=function(e){return this.mul(1/e)},e.prototype.divV=function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},e.prototype.clone=function(){return new e(this.x,this.y,this.z)},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.add=function(t,r){return new e(t.x+r.x,t.y+r.y,t.z+r.z)},e.sub=function(t,r){return new e(t.x-r.x,t.y-r.y,t.z-r.z)},e.mul=function(t,r){return new e(t.x*r,t.y*r,t.z*r)},e.mulV=function(t,r){return new e(t.x*r.x,t.y*r.y,t.z*r.z)},e.div=function(t,r){return e.mul(t,1/r)},e.divV=function(t,r){return new e(t.x/r.x,t.y/r.y,t.z/r.z)},e.inverse=function(t){return e.mul(t,-1)},e.norm=function(t){var r=t.mag();return e.div(t,r)},e.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},e.cross=function(t,r){return new e(t.y*r.z-t.z*r.y,t.z*r.x-t.x*r.z,t.x*r.y-t.y*r.x)},e.dist=function(t,r){return e.sub(t,r).mag()},e}(),i=function(){function e(e,t){this.elements=e,this._determinant=null,this._invMatrix=null,this._normalMatrix=null,void 0!==t&&(this._invMatrix=t,this._invMatrix._invMatrix=this)}return e.identity=function(){return new e(new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),new e(new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])))},e.translation=function(t,r,n){return new e(new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,t,r,n,1]),new e(new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,-t,-r,-n,1])))},e.translationV=function(t){return e.translation(t.x,t.y,t.z)},e.scaling=function(t,r,n){return new e(new Float32Array([t,0,0,0,0,r,0,0,0,0,n,0,0,0,0,1]),new e(new Float32Array([1/t,0,0,0,0,1/r,0,0,0,0,1/n,0,0,0,0,1])))},e.scalingV=function(t){return e.scaling(t.x,t.y,t.z)},e.rotationX=function(t){var r=Math.cos(t),n=Math.sin(t),i=Math.cos(-t),o=Math.sin(-t);return new e(new Float32Array([1,0,0,0,0,r,n,0,0,-n,r,0,0,0,0,1]),new e(new Float32Array([1,0,0,0,0,i,o,0,0,-o,i,0,0,0,0,1])))},e.rotationY=function(t){var r=Math.cos(t),n=Math.sin(t),i=Math.cos(-t),o=Math.sin(-t);return new e(new Float32Array([r,0,-n,0,0,1,0,0,n,0,r,0,0,0,0,1]),new e(new Float32Array([i,0,-o,0,0,1,0,0,o,0,i,0,0,0,0,1])))},e.rotationZ=function(t){var r=Math.cos(t),n=Math.sin(t),i=Math.cos(-t),o=Math.sin(-t);return new e(new Float32Array([r,n,0,0,-n,r,0,0,0,0,1,0,0,0,0,1]),new e(new Float32Array([i,o,0,0,-o,i,0,0,0,0,1,0,0,0,0,1])))},e.rotationXYZ=function(t){var r=Math.cos(t.x),n=Math.sin(t.x),i=Math.cos(t.y),o=Math.sin(t.y),a=Math.cos(t.z),u=Math.sin(t.z),s=Math.cos(-t.x),f=Math.sin(-t.x),c=Math.cos(-t.y),l=Math.sin(-t.y),h=Math.cos(-t.z),p=Math.sin(-t.z);return new e(new Float32Array([i*a,i*u,-o,0,n*o*a-r*u,n*o*u+r*a,n*i,0,r*o*a+n*u,r*o*u-n*a,r*i,0,0,0,0,1]),new e(new Float32Array([c*h,c*p,-l,0,f*l*h-s*p,f*l*p+s*h,f*c,0,s*l*h+f*p,s*l*p-f*h,s*c,0,0,0,0,1])))},e.transpose=function(t){var r=t.elements;return new e(new Float32Array([r[0],r[4],r[8],r[12],r[1],r[5],r[9],r[13],r[2],r[6],r[10],r[14],r[3],r[7],r[11],r[15]]))},e.inverse=function(e){return e.getInvMatrix()},e.mul=function(t,r){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];return n.reduce(function(t,r){return e._mul(t,r)},e._mul(t,r))},e._mul=function(t,r){var n=t.elements,i=r.elements;return new e(new Float32Array([n[0]*i[0]+n[1]*i[4]+n[2]*i[8]+n[3]*i[12],n[0]*i[1]+n[1]*i[5]+n[2]*i[9]+n[3]*i[13],n[0]*i[2]+n[1]*i[6]+n[2]*i[10]+n[3]*i[14],n[0]*i[3]+n[1]*i[7]+n[2]*i[11]+n[3]*i[15],n[4]*i[0]+n[5]*i[4]+n[6]*i[8]+n[7]*i[12],n[4]*i[1]+n[5]*i[5]+n[6]*i[9]+n[7]*i[13],n[4]*i[2]+n[5]*i[6]+n[6]*i[10]+n[7]*i[14],n[4]*i[3]+n[5]*i[7]+n[6]*i[11]+n[7]*i[15],n[8]*i[0]+n[9]*i[4]+n[10]*i[8]+n[11]*i[12],n[8]*i[1]+n[9]*i[5]+n[10]*i[9]+n[11]*i[13],n[8]*i[2]+n[9]*i[6]+n[10]*i[10]+n[11]*i[14],n[8]*i[3]+n[9]*i[7]+n[10]*i[11]+n[11]*i[15],n[12]*i[0]+n[13]*i[4]+n[14]*i[8]+n[15]*i[12],n[12]*i[1]+n[13]*i[5]+n[14]*i[9]+n[15]*i[13],n[12]*i[2]+n[13]*i[6]+n[14]*i[10]+n[15]*i[14],n[12]*i[3]+n[13]*i[7]+n[14]*i[11]+n[15]*i[15]]))},e.basis=function(t,r,n){return new e(new Float32Array([t.x,t.y,t.z,0,r.x,r.y,r.z,0,n.x,n.y,n.z,0,0,0,0,1]))},e.perspective=function(t,r,n,i){var o=r*Math.PI/180,a=n*Math.tan(.5*o),u=i-n;return new e(new Float32Array([n/(t*a),0,0,0,0,n/a,0,0,0,0,-(i+n)/u,-1,0,0,-2*i*n/u,0]))},e.orthographic=function(t,r,n,i){var o=1/(i-n);return new e(new Float32Array([2/t,0,0,0,0,2/r,0,0,0,0,-2*o,0,0,0,-(i+n)*o,1]))},e.prototype.determinant=function(){if(null===this._determinant){var e=this.elements;this._determinant=e[0]*(e[5]*e[10]*e[15]+e[9]*e[14]*e[7]+e[13]*e[6]*e[11]-e[13]*e[10]*e[7]-e[9]*e[6]*e[15]-e[5]*e[14]*e[11])-e[4]*(e[1]*e[10]*e[15]+e[9]*e[14]*e[3]+e[13]*e[2]*e[11]-e[13]*e[10]*e[3]-e[9]*e[2]*e[15]-e[1]*e[14]*e[11])+e[8]*(e[1]*e[6]*e[15]+e[5]*e[14]*e[3]+e[13]*e[2]*e[7]-e[13]*e[6]*e[3]-e[5]*e[2]*e[15]-e[1]*e[14]*e[7])-e[8]*(e[1]*e[6]*e[11]+e[5]*e[10]*e[3]+e[9]*e[2]*e[7]-e[9]*e[6]*e[3]-e[5]*e[2]*e[11]-e[1]*e[10]*e[7])}return this._determinant},e.prototype.getInvMatrix=function(){if(null===this._invMatrix){var t=this.determinant();if(Math.abs(t)<=0)throw new Error("not invertiable");var r=1/t,n=this.elements;this._invMatrix=new e(new Float32Array([(n[5]*n[10]*n[15]+n[9]*n[14]*n[7]+n[13]*n[6]*n[11]-n[13]*n[10]*n[7]-n[9]*n[6]*n[15]-n[5]*n[14]*n[11])*r,-(n[1]*n[10]*n[15]+n[9]*n[14]*n[3]+n[13]*n[2]*n[11]-n[13]*n[10]*n[3]-n[9]*n[2]*n[15]-n[1]*n[14]*n[11])*r,(n[1]*n[6]*n[15]+n[5]*n[14]*n[3]+n[13]*n[2]*n[7]-n[13]*n[6]*n[3]-n[5]*n[2]*n[15]-n[1]*n[14]*n[7])*r,-(n[1]*n[6]*n[11]+n[5]*n[10]*n[3]+n[9]*n[2]*n[7]-n[9]*n[6]*n[3]-n[5]*n[2]*n[11]-n[1]*n[10]*n[7])*r,-(n[4]*n[10]*n[15]+n[8]*n[14]*n[7]+n[12]*n[6]*n[11]-n[12]*n[10]*n[7]-n[8]*n[6]*n[15]-n[4]*n[14]*n[11])*r,(n[0]*n[10]*n[15]+n[8]*n[14]*n[3]+n[12]*n[2]*n[11]-n[12]*n[10]*n[3]-n[8]*n[2]*n[15]-n[0]*n[14]*n[11])*r,-(n[0]*n[6]*n[15]+n[4]*n[14]*n[3]+n[12]*n[2]*n[7]-n[12]*n[6]*n[3]-n[4]*n[2]*n[15]-n[0]*n[14]*n[7])*r,(n[0]*n[6]*n[11]+n[4]*n[10]*n[3]+n[8]*n[2]*n[7]-n[8]*n[6]*n[3]-n[4]*n[2]*n[11]-n[0]*n[10]*n[7])*r,(n[4]*n[9]*n[15]+n[8]*n[13]*n[7]+n[12]*n[5]*n[11]-n[12]*n[9]*n[7]-n[8]*n[5]*n[15]-n[4]*n[13]*n[11])*r,-(n[0]*n[9]*n[15]+n[8]*n[13]*n[3]+n[12]*n[1]*n[11]-n[12]*n[9]*n[3]-n[8]*n[1]*n[15]-n[0]*n[13]*n[11])*r,(n[0]*n[5]*n[15]+n[4]*n[13]*n[3]+n[12]*n[1]*n[7]-n[12]*n[5]*n[3]-n[4]*n[1]*n[15]-n[0]*n[13]*n[7])*r,-(n[0]*n[5]*n[11]+n[4]*n[9]*n[3]+n[8]*n[1]*n[7]-n[8]*n[5]*n[3]-n[4]*n[1]*n[11]-n[0]*n[9]*n[7])*r,-(n[4]*n[9]*n[14]+n[8]*n[13]*n[6]+n[12]*n[5]*n[10]-n[12]*n[9]*n[6]-n[8]*n[5]*n[14]-n[4]*n[13]*n[10])*r,(n[0]*n[9]*n[14]+n[8]*n[13]*n[2]+n[12]*n[1]*n[10]-n[12]*n[9]*n[2]-n[8]*n[1]*n[14]-n[0]*n[13]*n[10])*r,-(n[0]*n[5]*n[14]+n[4]*n[13]*n[2]+n[12]*n[1]*n[6]-n[12]*n[5]*n[2]-n[4]*n[1]*n[14]-n[0]*n[13]*n[6])*r,(n[0]*n[5]*n[10]+n[4]*n[9]*n[2]+n[8]*n[1]*n[6]-n[8]*n[5]*n[2]-n[4]*n[1]*n[10]-n[0]*n[9]*n[6])*r]),this)}return this._invMatrix},e.prototype.getNormalMatrix=function(){return null===this._normalMatrix&&(this._normalMatrix=e.transpose(this.getInvMatrix())),this._normalMatrix},e.lookAt=function(t,r,i){var o=n.sub(r,t).norm(),a=n.mul(o,-1),u=n.cross(i,a),s=n.cross(a,u);return new e(new Float32Array([u.x,u.y,u.z,0,s.x,s.y,s.z,0,a.x,a.y,a.z,0,t.x,t.y,t.z,1]))},e}(),o=function(){function e(e){var t=void 0===e?{}:e,r=t.aspect,o=void 0===r?1.3:r,a=t.vfov,u=void 0===a?60:a,s=t.near,f=void 0===s?.01:s,c=t.far,l=void 0===c?1e3:c,h=t.origin,p=void 0===h?new n(0,0,10):h,m=t.target,d=void 0===m?n.zero:m;this._aspect=o,this._vfov=u,this._near=f,this._far=l,this._position=p,this._matrix=i.lookAt(p,d,new n(0,1,0)),this._viewMatrix=this._matrix.getInvMatrix(),this._projMatrix=i.perspective(this._aspect,this._vfov,this._near,this._far),this._vpMatrix=i.mul(this._viewMatrix,this._projMatrix)}return Object.defineProperty(e.prototype,"position",{get:function(){return this._position.clone()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"matrix",{get:function(){return this._matrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"viewMatrix",{get:function(){return this._viewMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"projMatrix",{get:function(){return this._projMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vpMatrix",{get:function(){return this._vpMatrix},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"aspect",{get:function(){return this._aspect},set:function(e){this._aspect=e,this._projMatrix=i.perspective(this._aspect,this._vfov,this._near,this._far),this._vpMatrix=i.mul(this._viewMatrix,this._projMatrix)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"vfov",{get:function(){return this._vfov},set:function(e){this._vfov=e,this._projMatrix=i.perspective(this._aspect,this._vfov,this._near,this._far),this._vpMatrix=i.mul(this._viewMatrix,this._projMatrix)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"near",{get:function(){return this._near},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"far",{get:function(){return this._far},enumerable:!0,configurable:!0}),e.prototype.lookAt=function(e,t){this._position=e.clone(),this._matrix=i.lookAt(e,t,new n(0,1,0)),this._viewMatrix=this._matrix.getInvMatrix(),this._vpMatrix=i.mul(this._viewMatrix,this._projMatrix)},e}(),a=function(){function e(e,t){var r=void 0===t?{}:t,i=r.orbitRadius,o=void 0===i?30:i,a=r.orbitHeight,u=void 0===a?0:a,s=r.target,f=void 0===s?n.zero:s,c=r.speed,l=void 0===c?.1:c;this.camera=e,this.orbitAngle=0,this.orbitRadius=o,this.orbitHeight=u,this.target=f,this.speed=l}return e.prototype.reset=function(e){this.orbitAngle=0},e.prototype.update=function(e,t){this.orbitAngle+=this.speed*t;var r=new n(this.orbitRadius*Math.cos(this.orbitAngle),this.orbitHeight,this.orbitRadius*Math.sin(this.orbitAngle));this.camera.lookAt(r,this.target)},e}(),u=function(){function e(e,t,r,i,o){var a=void 0===o?{}:o,u=a.startDistance,s=void 0===u?5:u,f=a.switchNearDistance,c=void 0===f?2:f,l=a.switchFarDistance,h=void 0===l?20:l,p=a.switchSecs,m=void 0===p?10:p;this.camera=t,this.trails=r,this.boundaries=i,this.origin=n.zero,this.target=n.zero,this.targetIndex=0,this.focusingSecs=0,this.startDistance=s,this.switchNearDistance=c,this.switchFarDistance=h,this.switchSecs=m,this.resetTarget(e)}return e.prototype.reset=function(e){this.resetTarget(e)},e.prototype.update=function(e,t){this.focusingSecs+=t;var r=this.trails.getPosition(e,this.targetIndex),i=n.sub(r,this.target);this.target.add(i.mul(t)),this.camera.lookAt(this.origin,this.target);var o=n.dist(this.origin,this.target);(this.focusingSecs>this.switchSecs||o<this.switchNearDistance||o>this.switchFarDistance||Math.abs(n.dot(new n(0,1,0),n.sub(r,this.origin).norm()))>.75)&&this.resetTarget(e)},e.prototype.resetTarget=function(e){this.focusingSecs=0,this.targetIndex=Math.floor(Math.random()*this.trails.trailNum),this.target=this.trails.getPosition(e,this.targetIndex);var t=2*Math.PI*Math.random();this.origin=n.add(this.target,new n(this.startDistance*Math.cos(t),0,this.startDistance*Math.sin(t))),(Math.abs(this.origin.x)>this.boundaries.x||Math.abs(this.origin.y)>this.boundaries.y||Math.abs(this.origin.z)>this.boundaries.z||isNaN(this.origin.x)||isNaN(this.origin.y)||isNaN(this.origin.z))&&this.resetTarget(e)},e}(),s=function(){function e(e,t){this._width=e,this._height=t}return Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texture",{get:function(){throw new Error("can not get texture")},enumerable:!0,configurable:!0}),e.prototype.resize=function(e,t,r){this._width=t,this._height=r},Object.defineProperty(e.prototype,"framebuffer",{get:function(){return null},enumerable:!0,configurable:!0}),e}();function f(e,t,r){var n=e.createShader(r);if(e.shaderSource(n,t),e.compileShader(n),!e.getShaderParameter(n,e.COMPILE_STATUS))throw new Error(e.getShaderInfoLog(n)+t);return n}function c(e,t){var r=e.createBuffer();return e.bindBuffer(e.ARRAY_BUFFER,r),e.bufferData(e.ARRAY_BUFFER,t,e.STATIC_DRAW),e.bindBuffer(e.ARRAY_BUFFER,null),r}function l(e,t,r,n){var i=void 0===n?{}:n,o=i.internalFormat,a=void 0===o?e.RGBA:o,u=i.format,s=void 0===u?e.RGBA:u,f=i.type,c=void 0===f?e.UNSIGNED_BYTE:f,l=i.parameteri,h=void 0===l?[]:l,p=e.createTexture();return e.bindTexture(e.TEXTURE_2D,p),e.texImage2D(e.TEXTURE_2D,0,a,t,r,0,s,c,null),h.forEach(function(t){return e.texParameteri(e.TEXTURE_2D,t[0],t[1])}),e.bindTexture(e.TEXTURE_2D,null),p}function h(e,t){var r=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,r),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),e.bindFramebuffer(e.FRAMEBUFFER,null),r}function p(e,t,r,n){e.activeTexture(e.TEXTURE0+t),e.bindTexture(e.TEXTURE_2D,r),e.uniform1i(n,t)}function m(e,t,r){return l(e,t,r,{internalFormat:e.RGBA16F,format:e.RGBA,type:e.HALF_FLOAT,parameteri:[[e.TEXTURE_MAG_FILTER,e.LINEAR],[e.TEXTURE_MIN_FILTER,e.LINEAR],[e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE],[e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE]]})}var d=function(){function e(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)}return Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colorTexture0",{get:function(){return this._colorTexture0},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colorTexture1",{get:function(){return this._colorTexture1},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colorTexture2",{get:function(){return this._colorTexture2},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colorTexture3",{get:function(){return this._colorTexture3},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"depthTexture",{get:function(){return this._depthTexture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"framebuffer",{get:function(){return this._framebuffer},enumerable:!0,configurable:!0}),e.prototype.resize=function(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)},e.prototype.createFramebuffer=function(e){this._colorTexture0=m(e,this._width,this._height),this._colorTexture1=m(e,this._width,this._height),this._colorTexture2=m(e,this._width,this._height),this._colorTexture3=m(e,this._width,this._height),this._depthTexture=function(e,t,r){return l(e,t,r,{internalFormat:e.DEPTH_COMPONENT32F,format:e.DEPTH_COMPONENT,type:e.FLOAT,parameteri:[[e.TEXTURE_MAG_FILTER,e.NEAREST],[e.TEXTURE_MIN_FILTER,e.NEAREST],[e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE],[e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE]]})}(e,this._width,this._height),this._framebuffer=function(e,t,r,n,i,o){var a=e.createFramebuffer();return e.bindFramebuffer(e.FRAMEBUFFER,a),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,t,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT1,e.TEXTURE_2D,r,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT2,e.TEXTURE_2D,n,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT3,e.TEXTURE_2D,i,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,o,0),e.drawBuffers([e.COLOR_ATTACHMENT0,e.COLOR_ATTACHMENT1,e.COLOR_ATTACHMENT2,e.COLOR_ATTACHMENT3]),e.bindFramebuffer(e.FRAMEBUFFER,null),a}(e,this._colorTexture0,this._colorTexture1,this._colorTexture2,this._colorTexture3,this._depthTexture)},e}();var _=function(){function e(e,t,r,n){this.program=function(e,t,r){var n=e.createProgram();if(e.attachShader(n,t),e.attachShader(n,r),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS))throw new Error(e.getProgramInfoLog(n));return n}(e,t,r),this.uniforms=function(e,t,r){return r.reduce(function(r,n){return r.set(n,e.getUniformLocation(t,n)),r},new Map)}(e,this.program,n)}return e.prototype.getUniform=function(e){var t=this.uniforms.get(e);if(void 0===t)throw new Error("no uniform "+e);return t},e}(),g="#version 300 es\n\nout vec2 v_uv;\n\nconst vec2[4] POSITIONS = vec2[](\n  vec2(-1.0, -1.0),\n  vec2(1.0, -1.0),\n  vec2(-1.0, 1.0),\n  vec2(1.0, 1.0)\n);\n\nconst int[6] INDICES = int[](\n  0, 1, 2,\n  3, 2, 1\n);\n\nvoid main(void) {\n  vec2 pos = POSITIONS[INDICES[gl_VertexID]];\n  v_uv = pos * 0.5 + 0.5;\n  gl_Position = vec4(pos, 0.0, 1.0);\n}",v="#version 300 es\n\nprecision highp float;\n\nin vec2 v_uv;\nout vec4 o_color;\n\nuniform sampler2D u_gBufferTexture0; // xyz: albedo, w: object type\nuniform sampler2D u_gBufferTexture1; // xyz: reflectance, w: reflect intensity\nuniform sampler2D u_gBufferTexture2; // xyz: world position\nuniform sampler2D u_gBufferTexture3; // xyz: world normal\nuniform vec3 u_cameraPos;\nuniform vec3 u_wallSize;\nuniform float u_lightSize;\nuniform vec3 u_lightColor;\nuniform float u_time;\n\n#define INV_PI 0.31830988618\n\nstruct GBuffer {\n    vec3 albedo;\n    int type; // 0: bottom, 1: top, 2: left, 3: right, 4: far, 5: near, 6: trails\n    vec3 reflectance;\n    float refIntensity;\n    vec3 worldPosition;\n    vec3 worldNormal;\n};\n\nGBuffer getGBuffer() {\n    GBuffer gBuffer;\n    vec4 tex0 = texture(u_gBufferTexture0, v_uv);\n    vec4 tex1 = texture(u_gBufferTexture1, v_uv);\n    gBuffer.albedo = tex0.xyz;\n    gBuffer.type = int(tex0.w);\n    gBuffer.reflectance = tex1.xyz;\n    gBuffer.refIntensity = tex1.w;\n    gBuffer.worldPosition = texture(u_gBufferTexture2, v_uv).xyz;\n    gBuffer.worldNormal = texture(u_gBufferTexture3, v_uv).xyz;\n    return gBuffer;\n}\n\nfloat random(float x){\n    return fract(sin(x * 12.9898) * 43758.5453);\n}\n\nfloat srandom(float x) {\n    return 2.0 * random(x) - 1.0;\n}\n\nfloat random(vec2 x){\n    return fract(sin(dot(x,vec2(12.9898, 78.233))) * 43758.5453);\n}\n\nvec3 palette(float t, vec3 a, vec3 b, vec3 c, vec3 d) {\n    return a + b * cos(6.28318530718 * (t * c + d));\n}\n\nvec3 schlickFresnel(vec3 f90, float cosine) {\n    return f90 + (1.0 - f90) * pow(1.0 - cosine, 5.0);\n}\n\nmat2 rotate(float r) {\n    float c = cos(r);\n    float s = sin(r);\n    return mat2(c, s, -s, c);\n}\n\nvec3 calcWallEmission1(vec3 pos) {\n    for (float i = 1.0; i < 5.0; i++) {\n        pos.y += i * 2.0 * sin(0.014 * pos.x - 0.03 * i * u_time);\n        pos.y += i * 2.0 * sin(-0.009 * pos.z + 0.13 * i * u_time);\n        pos.xz *= 2.0;\n        pos.xy *= rotate(0.17 * srandom(i));\n        pos.yz *= rotate(0.14 * srandom(i * 1.01));\n    }\n    pos.y *= 2.0;\n    vec3 c = palette(\n        -0.1 * u_time + 0.005 * floor(pos.y * INV_PI) + 0.1 * random(floor(pos.y * INV_PI)),\n        vec3(0.5), vec3(0.5), vec3(1.0), vec3(0.0, 0.28, 0.3));\n    return mix(vec3(0.0), 1.2 * c, pow(abs(sin(1.0 * pos.y)), 0.2));\n}\n\nvec3 calcWallEmission(int type, vec3 pos) {\n    return calcWallEmission1(pos);\n}\n\nvec3 calcCeilEmission(vec3 position) {\n    if (abs(position.x) < u_lightSize && abs(position.z) < u_lightSize) {\n        return u_lightColor;\n    }\n    return vec3(0.0);\n}\n\nvec3 hitWalls(vec3 ro, vec3 rd, vec3 wallSize) {\n    float t = 1e6;\n    int wallType = 0; // 0: right, left, front, near, 1: top, 2: bottom\n    vec3 position;\n    float tb = (-wallSize.y - ro.y) / rd.y;\n    if (tb > 0.0 && tb < t) {\n        t = tb;\n        wallType = 0;\n        position = ro + t * rd;\n    }\n    float tt = (wallSize.y - ro.y) / rd.y;\n    if (tt > 0.0 && tt < t) {\n        t = tt;\n        wallType = 1;\n        position = ro + t * rd;\n    }\n    float tl = (-wallSize.x - ro.x) / rd.x;\n    if (tl > 0.0 && tl < t) {\n        t = tl;\n        wallType = 2;\n        position = ro + t * rd;\n    }\n    float tr = (wallSize.x - ro.x) / rd.x;\n    if (tr > 0.0 && tr < t) {\n        t = tr;\n        wallType = 3;\n        position = ro + t * rd;\n    }\n    float tf = (-wallSize.z - ro.z) / rd.z;\n    if (tf > 0.0 && tf < t) {\n        t = tf;\n        wallType = 4;\n        position = ro + t * rd;\n    }\n    float tn = (wallSize.z - ro.z) / rd.z;\n    if (tn > 0.0 && tn < t) {\n        t = tn;\n        wallType = 5;\n        position = ro + t * rd;\n    }\n\n    if (t < 1e6) {\n        float d = distance(ro, position);\n        float decay = exp(-d * 0.01);\n        if (wallType == 2 || wallType == 3 || wallType == 4 || wallType == 5) {\n            return decay * calcWallEmission(wallType, position);\n        } else if (wallType == 1) {\n            return decay * calcCeilEmission(position);\n        }\n    }\n    return vec3(0.0);\n}\n\nvoid main(void) {\n    GBuffer gBuffer = getGBuffer();\n\n    vec3 emission;\n    if (gBuffer.type == 2 || gBuffer.type == 3 || gBuffer.type == 4 || gBuffer.type == 5) {\n        emission = calcWallEmission(gBuffer.type, gBuffer.worldPosition);\n    } else if (gBuffer.type == 1) {\n        emission = calcCeilEmission(gBuffer.worldPosition);\n    } else {\n        vec3 viewDir = normalize(u_cameraPos - gBuffer.worldPosition);\n        vec3 refDir = reflect(-viewDir, gBuffer.worldNormal);\n        float dotNV = clamp(dot(gBuffer.worldNormal, refDir), 0.0, 1.0);\n        vec3 fresnel = schlickFresnel(gBuffer.reflectance, dotNV);\n        emission = gBuffer.refIntensity * fresnel * hitWalls(gBuffer.worldPosition + 0.01 * refDir, refDir, u_wallSize);\n    }\n\n    vec3 diffuse = gBuffer.albedo * min((dot(vec3(0.0, 1.0, 0.0), gBuffer.worldNormal) * 0.5 + 0.5), 1.0);\n    vec3 c = diffuse + emission;\n\n    o_color = vec4(c, 1.0);\n}",x={gBufferTexture0:"u_gBufferTexture0",gBufferTexture1:"u_gBufferTexture1",gBufferTexture2:"u_gBufferTexture2",gBufferTexture3:"u_gBufferTexture3",cameraPos:"u_cameraPos",wallSize:"u_wallSize",lightSize:"u_lightSize",lightColor:"u_lightColor",time:"u_time"},b=function(){function e(e,t){var r=void 0===t?{}:t,i=r.lightSize,o=void 0===i?25:i,a=r.lightColor,u=void 0===a?new n(1,1,1):a;this.lightSize=o,this.lightColor=u;var s=f(e,g,e.VERTEX_SHADER),c=f(e,v,e.FRAGMENT_SHADER);this.program=new _(e,s,c,Object.values(x))}return e.prototype.apply=function(e,t,r,n,i){e.useProgram(this.program.program),p(e,0,t.colorTexture0,this.program.getUniform(x.gBufferTexture0)),p(e,1,t.colorTexture1,this.program.getUniform(x.gBufferTexture1)),p(e,2,t.colorTexture2,this.program.getUniform(x.gBufferTexture2)),p(e,3,t.colorTexture3,this.program.getUniform(x.gBufferTexture3)),e.uniform3fv(this.program.getUniform(x.cameraPos),r.position.toArray()),e.uniform3fv(this.program.getUniform(x.wallSize),n.toArray()),e.uniform1f(this.program.getUniform(x.lightSize),this.lightSize),e.uniform3fv(this.program.getUniform(x.lightColor),this.lightColor.toArray()),e.uniform1f(this.program.getUniform(x.time),i),e.drawArrays(e.TRIANGLES,0,6)},e}();var T=function(){function e(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)}return Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texture",{get:function(){return this._texture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"framebuffer",{get:function(){return this._framebuffer},enumerable:!0,configurable:!0}),e.prototype.resize=function(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)},e.prototype.createFramebuffer=function(e){this._texture=function(e,t,r){return l(e,t,r,{internalFormat:e.RGBA16F,format:e.RGBA,type:e.HALF_FLOAT,parameteri:[[e.TEXTURE_MAG_FILTER,e.LINEAR],[e.TEXTURE_MIN_FILTER,e.LINEAR],[e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE],[e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE]]})}(e,this._width,this._height),this._framebuffer=h(e,this.texture)},e}(),y=function(){function e(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)}return Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texture",{get:function(){return this.readableRenderTarget.texture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"framebuffer",{get:function(){return this.writableRenderTarget.framebuffer},enumerable:!0,configurable:!0}),e.prototype.resize=function(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)},e.prototype.swap=function(){var e;e=[this.writableRenderTarget,this.readableRenderTarget],this.readableRenderTarget=e[0],this.writableRenderTarget=e[1]},e.prototype.createFramebuffer=function(e){this.readableRenderTarget=new T(e,this._width,this._height),this.writableRenderTarget=new T(e,this._width,this._height)},e}();var w=function(){function e(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)}return Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texture",{get:function(){return this._texture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"framebuffer",{get:function(){return this._framebuffer},enumerable:!0,configurable:!0}),e.prototype.resize=function(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)},e.prototype.createFramebuffer=function(e){this._texture=function(e,t,r){return l(e,t,r,{parameteri:[[e.TEXTURE_MAG_FILTER,e.LINEAR],[e.TEXTURE_MIN_FILTER,e.LINEAR],[e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE],[e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE]]})}(e,this._width,this._height),this._framebuffer=h(e,this.texture)},e}(),E=function(){function e(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)}return Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"height",{get:function(){return this._height},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"texture",{get:function(){return this.readableRenderTarget.texture},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"framebuffer",{get:function(){return this.writableRenderTarget.framebuffer},enumerable:!0,configurable:!0}),e.prototype.resize=function(e,t,r){this._width=t,this._height=r,this.createFramebuffer(e)},e.prototype.swap=function(){var e;e=[this.writableRenderTarget,this.readableRenderTarget],this.readableRenderTarget=e[0],this.writableRenderTarget=e[1]},e.prototype.createFramebuffer=function(e){this.readableRenderTarget=new w(e,this._width,this._height),this.writableRenderTarget=new w(e,this._width,this._height)},e}(),R="#version 300 es\n\nprecision highp float;\n\nin vec2 v_uv;\nout vec4 o_color;\n\nuniform sampler2D u_srcTexture;\n\nvoid main(void) {\n    o_color = vec4(texture(u_srcTexture, v_uv).rgb, 1.0);\n}",A=function(){function e(e){var t=f(e,g,e.VERTEX_SHADER),r=f(e,R,e.FRAGMENT_SHADER);this.program=new _(e,t,r,["u_srcTexture"])}return e.prototype.apply=function(e,t,r,n){e.bindFramebuffer(e.FRAMEBUFFER,r.framebuffer),e.viewport(0,0,r.width,r.height),e.useProgram(this.program.program),p(e,0,t.texture,this.program.getUniform("u_srcTexture")),e.drawArrays(e.TRIANGLES,0,6)},e}(),F="#version 300 es\n\nprecision highp float;\n\nout vec4 o_color;\n\nuniform sampler2D u_srcTexture;\nuniform bool u_horizontal;\n\nconst float[5] weights = float[](0.2270270, 0.1945945, 0.1216216, 0.0540540, 0.0162162);\n\nivec2 clampCoord(ivec2 coord, ivec2 texSize) {\n    return max(min(coord, texSize - 1), 0);\n}\n\nvoid main(void) {\n    ivec2 coord = ivec2(gl_FragCoord.xy);\n    ivec2 texSize = textureSize(u_srcTexture, 0);\n    vec3 sum = weights[0] * texelFetch(u_srcTexture, coord, 0).rgb;\n    for (int i = 1; i < 5; i++) {\n        ivec2 offset = u_horizontal ? ivec2(i, 0) : ivec2(0, i);\n        sum += weights[i] * texelFetch(u_srcTexture, clampCoord(coord + offset, texSize), 0).rgb;\n        sum += weights[i] * texelFetch(u_srcTexture, clampCoord(coord - offset, texSize), 0).rgb;\n    }\n    o_color = vec4(sum, 1.0);\n}",M=function(){function e(e,t,r){var n=f(e,g,e.VERTEX_SHADER),i=f(e,F,e.FRAGMENT_SHADER);this.program=new _(e,n,i,["u_srcTexture","u_horizontal"]),this.renderTarget=new y(e,t,r),this.copyFilter=new A(e)}return e.prototype.apply=function(e,t,r){this.copyFilter.apply(e,t,this.renderTarget,r),this.renderTarget.swap(),e.viewport(0,0,this.renderTarget.width,this.renderTarget.height);for(var n=0;n<5;n++)e.bindFramebuffer(e.FRAMEBUFFER,this.renderTarget.framebuffer),e.useProgram(this.program.program),p(e,0,this.renderTarget.texture,this.program.getUniform("u_srcTexture")),e.uniform1i(this.program.getUniform("u_horizontal"),1),e.drawArrays(e.TRIANGLES,0,6),this.renderTarget.swap(),e.bindFramebuffer(e.FRAMEBUFFER,this.renderTarget.framebuffer),e.useProgram(this.program.program),p(e,0,this.renderTarget.texture,this.program.getUniform("u_srcTexture")),e.uniform1i(this.program.getUniform("u_horizontal"),0),e.drawArrays(e.TRIANGLES,0,6),this.renderTarget.swap();return this.renderTarget.texture},e}(),S="#version 300 es\n\nprecision highp float;\n\nin vec2 v_uv;\nout vec4 o_color;\n\nuniform sampler2D u_srcTexture;\nuniform float u_threshold;\nuniform float u_intensity;\n\nvoid main(void) {\n    o_color = vec4(u_intensity * max(texture(u_srcTexture, v_uv).rgb - u_threshold, 0.0) / (1.0 - u_threshold + 0.01), 1.0);\n}",P="#version 300 es\n\nprecision highp float;\n\nin vec2 v_uv;\nout vec4 o_color;\n\nuniform sampler2D u_srcTexture;\nuniform sampler2D u_blurTexture0;\nuniform sampler2D u_blurTexture1;\nuniform sampler2D u_blurTexture2;\nuniform sampler2D u_blurTexture3;\n\nvoid main(void) {\n    vec3 c = vec3(0.0);\n    c += texture(u_srcTexture, v_uv).rgb;\n    c += 2.0 * texture(u_blurTexture0, v_uv).rgb;\n    c += 4.0 * texture(u_blurTexture1, v_uv).rgb;\n    c += 6.0 * texture(u_blurTexture2, v_uv).rgb;\n    c += 8.0 * texture(u_blurTexture3, v_uv).rgb;\n    o_color = vec4(c, 1.0);\n}",z=function(){function e(e,t,r,n){var i=void 0===n?{}:n,o=i.threshold,a=void 0===o?1:o,u=i.intensity,s=void 0===u?.1:u;this.threshold=a,this.intensity=s;var c=f(e,g,e.VERTEX_SHADER),l=f(e,P,e.FRAGMENT_SHADER),h=f(e,S,e.FRAGMENT_SHADER);this.extractLuminanceProgram=new _(e,c,h,["u_srcTexture","u_threshold","u_intensity"]),this.bloomProgram=new _(e,c,l,["u_srcTexture","u_blurTexture0","u_blurTexture1","u_blurTexture2","u_blurTexture3"]),this.luminanceBuffer=new T(e,t,r),this.blurApplier0=new M(e,t/4,r/4),this.blurApplier1=new M(e,t/8,r/8),this.blurApplier2=new M(e,t/16,r/16),this.blurApplier3=new M(e,t/32,r/32)}return e.prototype.resize=function(e,t,r){this.luminanceBuffer=new T(e,t,r),this.blurApplier0=new M(e,t/4,r/4),this.blurApplier1=new M(e,t/8,r/8),this.blurApplier2=new M(e,t/16,r/16),this.blurApplier3=new M(e,t/32,r/32)},e.prototype.apply=function(e,t,r,n){var i=this;this.extractLuminance(e,t);var o=this.blurApplier0.apply(e,this.luminanceBuffer,n),a=this.blurApplier1.apply(e,this.luminanceBuffer,n),u=this.blurApplier2.apply(e,this.luminanceBuffer,n),s=this.blurApplier3.apply(e,this.luminanceBuffer,n);e.bindFramebuffer(e.FRAMEBUFFER,r.framebuffer),e.viewport(0,0,r.width,r.height),e.useProgram(this.bloomProgram.program),[[t.texture,"u_srcTexture"],[o,"u_blurTexture0"],[a,"u_blurTexture1"],[u,"u_blurTexture2"],[s,"u_blurTexture3"]].forEach(function(t,r){p(e,r,t[0],i.bloomProgram.getUniform(t[1]))}),e.drawArrays(e.TRIANGLES,0,6)},e.prototype.extractLuminance=function(e,t){e.bindFramebuffer(e.FRAMEBUFFER,this.luminanceBuffer.framebuffer),e.viewport(0,0,this.luminanceBuffer.width,this.luminanceBuffer.height),e.useProgram(this.extractLuminanceProgram.program),p(e,0,t.texture,this.extractLuminanceProgram.getUniform("u_srcTexture")),e.uniform1f(this.extractLuminanceProgram.getUniform("u_threshold"),this.threshold),e.uniform1f(this.extractLuminanceProgram.getUniform("u_intensity"),this.intensity),e.drawArrays(e.TRIANGLES,0,6)},e}(),B="#version 300 es\n\nprecision highp float;\n\nin vec2 v_uv;\nout vec4 o_color;\n\nuniform sampler2D u_srcTexture;\nuniform sampler2D u_blurredSrcTexture;\nuniform sampler2D u_depthTexture;\nuniform float u_near;\nuniform float u_far;\nuniform float u_focalDistance;\nuniform float u_focalRegion;\nuniform float u_nearTransition;\nuniform float u_farTransition;\n\nfloat toLinearDepth(float depth, float near, float far) {\n    float nz = near * depth;\n    return -nz / (far * (depth - 1.0) - nz);\n}\n\nfloat toViewZ(float depth, float near, float far) {\n    return near + (far - near) * toLinearDepth(depth, near, far);\n}\n\nvoid main(void) {\n    vec3 col = texture(u_srcTexture, v_uv).rgb;\n    vec3 blurredCol = texture(u_blurredSrcTexture, v_uv).rgb;\n    float depth = texture(u_depthTexture, v_uv).x;\n\n    float viewZ = toViewZ(depth, u_near, u_far);\n\n    float nearTransStart = u_focalDistance - u_nearTransition;\n    float nearTransEnd = u_focalDistance;\n    float farTransStart = u_focalDistance + u_focalRegion;\n    float farTransEnd = farTransStart + u_farTransition;\n\n    // o_color = vec4(blurredCol, 1.0);\n    // return;\n\n    vec3 c;\n    if (viewZ < nearTransEnd) {\n        c = mix(blurredCol, col, smoothstep(nearTransStart, nearTransEnd, viewZ));\n    } else if (viewZ < farTransStart) {\n        c = col;\n    } else {\n        c = mix(col, blurredCol, smoothstep(farTransStart, farTransEnd, viewZ));\n    }\n\n    o_color = vec4(c, 1.0);\n}",U={srcTexture:"u_srcTexture",blurredSrcTexture:"u_blurredSrcTexture",depthTexture:"u_depthTexture",near:"u_near",far:"u_far",focalDistance:"u_focalDistance",focalRegin:"u_focalRegion",nearTransition:"u_nearTransition",farTransition:"u_farTransition"},N=function(){function e(e,t,r,n){var i=void 0===n?{}:n,o=i.focalDistance,a=void 0===o?10:o,u=i.focalRegion,s=void 0===u?10:u,c=i.nearTransition,l=void 0===c?5:c,h=i.farTransition,p=void 0===h?30:h;this.focalDistance=a,this.focalRegion=s,this.nearTransition=l,this.farTransition=p;var m=f(e,g,e.VERTEX_SHADER),d=f(e,B,e.FRAGMENT_SHADER);this.program=new _(e,m,d,Object.values(U)),this.blurApplier=new M(e,.5*t,.5*r)}return e.prototype.apply=function(e,t,r,n){var i=this.blurApplier.apply(e,t,n);e.bindFramebuffer(e.FRAMEBUFFER,r.framebuffer),e.viewport(0,0,r.width,r.height),e.useProgram(this.program.program),p(e,0,t.texture,this.program.getUniform(U.srcTexture)),p(e,1,i,this.program.getUniform(U.blurredSrcTexture)),p(e,2,n.gBuffer.depthTexture,this.program.getUniform(U.depthTexture)),e.uniform1f(this.program.getUniform(U.near),n.camera.near),e.uniform1f(this.program.getUniform(U.far),n.camera.far),e.uniform1f(this.program.getUniform(U.focalDistance),this.focalDistance),e.uniform1f(this.program.getUniform(U.focalRegin),this.focalRegion),e.uniform1f(this.program.getUniform(U.nearTransition),this.nearTransition),e.uniform1f(this.program.getUniform(U.farTransition),this.farTransition),e.drawArrays(e.TRIANGLES,0,6)},e.prototype.resize=function(e,t,r){this.blurApplier=new M(e,.5*t,.5*r)},e}(),D="#version 300 es\n\nprecision highp float;\n\nin vec2 v_uv;\nout vec4 o_color;\n\nuniform sampler2D u_srcTexture;\nuniform sampler2D u_depthTexture;\nuniform float u_near;\nuniform float u_far;\nuniform float u_intensity;\n\nfloat toLinearDepth(float depth, float near, float far) {\n    float nz = near * depth;\n    return -nz / (far * (depth - 1.0) - nz);\n}\n\nfloat toViewZ(float depth, float near, float far) {\n    return near + (far - near) * toLinearDepth(depth, near, far);\n}\n\nfloat expFog(float d, float intensity) {\n    return exp(-d * intensity);\n}\n\nvoid main(void) {\n    vec3 c = texture(u_srcTexture, v_uv).rgb;\n    float d = toViewZ(texture(u_depthTexture, v_uv).x, u_near, u_far);\n\n    o_color = vec4(\n        mix(vec3(0.0), c, expFog(d, u_intensity)),\n        1.0\n    );\n}",O=function(){function e(e,t){var r=(void 0===t?{}:t).intensity,n=void 0===r?.01:r;this.intensity=n;var i=f(e,g,e.VERTEX_SHADER),o=f(e,D,e.FRAGMENT_SHADER);this.program=new _(e,i,o,["u_srcTexture","u_depthTexture","u_near","u_far","u_intensity"])}return e.prototype.apply=function(e,t,r,n){e.bindFramebuffer(e.FRAMEBUFFER,r.framebuffer),e.viewport(0,0,r.width,r.height),e.useProgram(this.program.program),p(e,0,t.texture,this.program.getUniform("u_srcTexture")),p(e,1,n.gBuffer.depthTexture,this.program.getUniform("u_depthTexture")),e.uniform1f(this.program.getUniform("u_near"),n.camera.near),e.uniform1f(this.program.getUniform("u_far"),n.camera.far),e.uniform1f(this.program.getUniform("u_intensity"),this.intensity),e.drawArrays(e.TRIANGLES,0,6)},e}(),I="#version 300 es\n\nprecision highp float;\n\nin vec2 v_uv;\nout vec4 o_color;\n\nuniform sampler2D u_srcTexture;\n\nvoid main(void) {\n    vec3 c = texture(u_srcTexture, v_uv).rgb;\n    o_color = vec4(pow(c, vec3(1.0 / 2.2)), 1.0);\n}",L=function(){function e(e){var t=f(e,g,e.VERTEX_SHADER),r=f(e,I,e.FRAGMENT_SHADER);this.program=new _(e,t,r,["u_srcTexture"])}return e.prototype.apply=function(e,t,r,n){e.bindFramebuffer(e.FRAMEBUFFER,r.framebuffer),e.viewport(0,0,r.width,r.height),e.useProgram(this.program.program),p(e,0,t.texture,this.program.getUniform("u_srcTexture")),e.drawArrays(e.TRIANGLES,0,6)},e}(),C="#version 300 es\n\n//ref: https://qiita.com/edo_m18/items/c211fea23b4747a8da3c\n\nprecision highp float;\n\nin vec2 v_uv;\n\nout vec4 o_color;\n\nuniform sampler2D u_srcTexture;\nuniform vec2 u_resolution;\n\nconst float FXAA_SPAN_MAX = 8.0;\nconst float FXAA_REDUCE_MUL = 1.0 / 8.0;\nconst float FXAA_SUBPIX_SHIFT = 1.0 / 4.0;\n#define FXAA_REDUCE_MIN (1.0 / 128.0)\n\n#define FxaaTexLod0(t, p) texture(t, p)\n#define FxaaTexOff(t, p, o, r) texture(t, p + o * r)\n\nvoid main(void) {\n\n    vec2 rcpFrame  = 1.0 / u_resolution;\n    vec4 posPos = vec4(v_uv, v_uv - rcpFrame * (0.5 + FXAA_SUBPIX_SHIFT));\n\n    vec3 rgbNW = FxaaTexLod0(u_srcTexture, posPos.zw).rgb;\n    vec3 rgbNE = FxaaTexOff(u_srcTexture, posPos.zw, vec2(1.0, 0.0), rcpFrame).rgb;\n    vec3 rgbSW = FxaaTexOff(u_srcTexture, posPos.zw, vec2(0.0, 1.0), rcpFrame).rgb;\n    vec3 rgbSE = FxaaTexOff(u_srcTexture, posPos.zw, vec2(1.0, 1.0), rcpFrame).rgb;\n    vec3 rgbM = FxaaTexLod0(u_srcTexture, posPos.xy).rgb;\n\n    vec3 luma = vec3(0.299, 0.587, 0.114);\n    float lumaNW = dot(rgbNW, luma);\n    float lumaNE = dot(rgbNE, luma);\n    float lumaSW = dot(rgbSW, luma);\n    float lumaSE = dot(rgbSE, luma);\n    float lumaM = dot(rgbM, luma);\n\n    float lumaMin = min(lumaM, min(min(lumaNW, lumaNE), min(lumaSW, lumaSE)));\n    float lumaMax = max(lumaM, max(max(lumaNW, lumaNE), max(lumaSW, lumaSE)));\n\n    vec2 dir = vec2(\n        -((lumaNW + lumaNE) - (lumaSW + lumaSE)),\n        ((lumaNW + lumaSW) - (lumaNE + lumaSE))\n    );\n\n    float dirReduce = max(\n        (lumaNW + lumaNE + lumaSW + lumaSE) * (0.25 * FXAA_REDUCE_MUL),\n        FXAA_REDUCE_MIN\n    );\n\n    float rcpDirMin = 1.0 / (min(abs(dir.x), abs(dir.y)) + dirReduce);\n    dir = min(vec2(FXAA_SPAN_MAX, FXAA_SPAN_MAX), max(vec2(-FXAA_SPAN_MAX, -FXAA_SPAN_MAX), dir * rcpDirMin)) * rcpFrame;\n\n    vec3 rgbA = 0.5 * (\n        FxaaTexLod0(u_srcTexture, posPos.xy + dir * (1.0 / 3.0 - 0.5)).rgb +\n        FxaaTexLod0(u_srcTexture, posPos.xy + dir * (2.0 / 3.0 - 0.5)).rgb);\n    vec3 rgbB = rgbA * 0.5 + 0.25 * (\n        FxaaTexLod0(u_srcTexture, posPos.xy + dir * (-0.5)).rgb +\n        FxaaTexLod0(u_srcTexture, posPos.xy + dir * (1.0 - 0.5)).rgb);\n\n    float lumaB = dot(rgbB, luma);\n    if ((lumaB < lumaMin) || (lumaB > lumaMax)) {\n        o_color = vec4(rgbA, 1.0);\n    } else {\n        o_color = vec4(rgbB, 1.0);\n    }\n}",j=function(){function e(e){var t=f(e,g,e.VERTEX_SHADER),r=f(e,C,e.FRAGMENT_SHADER);this.program=new _(e,t,r,["u_srcTexture","u_resolution"])}return e.prototype.apply=function(e,t,r,n){e.bindFramebuffer(e.FRAMEBUFFER,r.framebuffer),e.viewport(0,0,r.width,r.height),e.useProgram(this.program.program),p(e,0,t.texture,this.program.getUniform("u_srcTexture")),e.uniform2f(this.program.getUniform("u_resolution"),t.width,t.height),e.drawArrays(e.TRIANGLES,0,6)},e}(),X="#version 300 es\n\nout vec3 v_dir;\n\nuniform mat4 u_cameraMatrix;\nuniform vec2 u_focalScale;\n\nconst vec2[4] POSITIONS = vec2[](\n    vec2(-1.0, -1.0),\n    vec2(1.0, -1.0),\n    vec2(-1.0, 1.0),\n    vec2(1.0, 1.0)\n);\n\nconst int[6] INDICES = int[](\n    0, 1, 2,\n    3, 2, 1\n);\n\nvoid main(void) {\n    vec2 pos = POSITIONS[INDICES[gl_VertexID]];\n    v_dir = normalize((u_cameraMatrix * vec4(vec3(pos * u_focalScale, -1.0), 0.0)).xyz);\n    gl_Position = vec4(pos, 0.0, 1.0);\n}",G="#version 300 es\n\nprecision highp float;\n\nin vec3 v_dir;\n\nlayout (location = 0) out vec4 o_gBuffer0; // xyz: albedo, w: object type\nlayout (location = 1) out vec4 o_gBuffer1; // xyz: reflectance, w: reflectIntensity\nlayout (location = 2) out vec3 o_gBuffer2; // xyz: world position\nlayout (location = 3) out vec3 o_gBuffer3; // xyz: world normal\n\nuniform mat4 u_cameraMatrix;\nuniform mat4 u_viewMatrix;\nuniform float u_near;\nuniform float u_far;\nuniform vec3 u_wallSize;\nuniform float u_time;\n\nstruct GBuffer {\n    vec3 albedo;\n    int type; // 0: bottom, 1: top, 2: left, 3: right, 4: far, 5: near, 6: trails\n    vec3 reflectance;\n    float refIntensity;\n    vec3 worldPosition;\n    vec3 worldNormal;\n};\n\nvoid setGBuffer(GBuffer gBuffer) {\n    o_gBuffer0 = vec4(gBuffer.albedo, float(gBuffer.type) + 0.5);\n    o_gBuffer1 = vec4(gBuffer.reflectance, gBuffer.refIntensity);\n    o_gBuffer2 = gBuffer.worldPosition;\n    o_gBuffer3 = gBuffer.worldNormal;\n}\n\nvec3 calcTopEmission(vec3 position) {\n    if (abs(position.x) < 30.0 && abs(position.z) < 30.0) {\n        return vec3(2.0);\n    }\n    return vec3(0.2);\n}\n\nvec3 calcBottomEmission() {\n    return vec3(0.01);\n}\n\nbool hitWalls(vec3 ro, vec3 rd, vec3 wallSize) {\n    float t = 1e6;\n    int type;\n    vec3 position, normal;\n    float tb = (-wallSize.y - ro.y) / rd.y;\n    if (tb > 0.0 && tb < t) {\n        t = tb;\n        type = 0;\n        position = ro + t * rd;\n        normal = vec3(0.0, 1.0, 0.0);\n    }\n    float tt = (wallSize.y - ro.y) / rd.y;\n    if (tt > 0.0 && tt < t) {\n        t = tt;\n        type = 1;\n        position = ro + t * rd;\n        normal = vec3(0.0, -1.0, 0.0);\n    }\n    float tl = (-wallSize.x - ro.x) / rd.x;\n    if (tl > 0.0 && tl < t) {\n        t = tl;\n        type = 2;\n        position = ro + t * rd;\n        normal = vec3(1.0, 0.0, 0.0);\n    }\n    float tr = (wallSize.x - ro.x) / rd.x;\n    if (tr > 0.0 && tr < t) {\n        t = tr;\n        type = 3;\n        position = ro + t * rd;\n        normal = vec3(-1.0, 0.0, 0.0);\n    }\n    float tf = (-wallSize.z - ro.z) / rd.z;\n    if (tf > 0.0 && tf < t) {\n        t = tf;\n        type = 4;\n        position = ro + t * rd;\n        normal = vec3(0.0, 0.0, 1.0);\n    }\n    float tn = (wallSize.z - ro.z) / rd.z;\n    if (tn > 0.0 && tn < t) {\n        t = tn;\n        type = 5;\n        position = ro + t * rd;\n        normal = vec3(0.0, 0.0, -1.0);\n    }\n\n    if (t < 1e6) {\n        GBuffer gBuffer;\n        gBuffer.albedo = vec3(0.0);\n        gBuffer.type = type;\n        gBuffer.reflectance = vec3(0.2);\n        gBuffer.refIntensity = 0.5;\n        gBuffer.worldPosition = position;\n        gBuffer.worldNormal = normal;\n        setGBuffer(gBuffer);\n        gl_FragDepth = 0.5 + 0.5 * ((u_far + u_near) / (u_far - u_near) + (-2.0 * u_far * u_near) / ((u_far - u_near) * t));\n        return true;\n    }\n    return false;\n}\n\nvoid main(void) {\n    vec3 ro = (u_cameraMatrix * vec4(vec3(0.0), 1.0)).xyz;\n    vec3 rd = normalize(v_dir);\n\n    if (!hitWalls(ro, rd, u_wallSize)) {\n        discard;\n    }\n}",W=function(){function e(e,t){this.size=t;var r=f(e,X,e.VERTEX_SHADER),n=f(e,G,e.FRAGMENT_SHADER);this.program=new _(e,r,n,["u_cameraMatrix","u_viewMatrix","u_focalScale","u_near","u_far","u_wallSize","u_time"])}return e.prototype.render=function(e,t,r){e.useProgram(this.program.program),e.uniformMatrix4fv(this.program.getUniform("u_cameraMatrix"),!1,t.matrix.elements),e.uniformMatrix4fv(this.program.getUniform("u_viewMatrix"),!1,t.viewMatrix.elements);var n=Math.tan(.5*t.vfov*Math.PI/180);e.uniform2f(this.program.getUniform("u_focalScale"),t.aspect*n,n),e.uniform1f(this.program.getUniform("u_near"),t.near),e.uniform1f(this.program.getUniform("u_far"),t.far),e.uniform3fv(this.program.getUniform("u_wallSize"),this.size.toArray()),e.uniform1f(this.program.getUniform("u_time"),r),e.drawArrays(e.TRIANGLES,0,6)},e}(),V=function(){function e(e){this.fps=e,this.elapsedSecs=0,this.accumSecs=0,this.stepSecs=1/e}return e.prototype.addDeltaSecs=function(e,t){for(this.accumSecs+=e;this.accumSecs>this.stepSecs;)this.accumSecs-=this.stepSecs,this.elapsedSecs+=this.stepSecs,t(this.stepSecs,this.elapsedSecs)},e}(),H="#version 300 es\n\nprecision highp float;\n\nlayout (location = 0) out vec3 o_position;\nlayout (location = 1) out vec3 o_velocity;\nlayout (location = 2) out vec3 o_up;\n\nuniform vec3 u_boundaries;\nuniform float u_randomSeed;\n\nvec3 random3(float x) {\n    return fract(sin(x * vec3(12.9898, 51.431, 29.964)) * vec3(43758.5453, 71932.1354, 39215.4221));\n}\n\nvoid main(void) {\n    o_position = u_boundaries * (2.0 * random3(gl_FragCoord.x + u_randomSeed) - 1.0);\n    o_velocity = vec3(0.0);\n    o_up = vec3(0.0, 1.0, 0.0);\n}",Y="#version 300 es\n\nprecision highp float;\n\nlayout (location = 0) out vec3 o_position;\nlayout (location = 1) out vec3 o_velocity;\nlayout (location = 2) out vec3 o_up;\n\nuniform sampler2D u_positionTexture;\nuniform sampler2D u_velocityTexture;\nuniform sampler2D u_upTexture;\nuniform float u_deltaTime;\nuniform vec3 u_boundaries;\nuniform float u_maxSpeed;\nuniform float u_maxForce;\nuniform float u_sepRadius;\nuniform float u_aliRadius;\nuniform float u_cohRadius;\nuniform float u_sepWeight;\nuniform float u_aliWeight;\nuniform float u_cohWeight;\nuniform float u_boundSepRadius;\nuniform float u_boundSepWeight;\n\nvec3 limit(vec3 v, float max) {\n  if (length(v) > max) {\n    return normalize(v) * max;\n  }\n  return v;\n}\n\nvec3 calcForceFromBoundaries(vec3 pos, vec3 vel) {\n    vec3 separation = vec3(0.0);\n\n    float distNX = u_boundaries.x + pos.x;\n    if (distNX < u_boundSepRadius) {\n        separation += vec3(1.0, 0.0, 0.0) / distNX;\n    }\n    float distPX = u_boundaries.x - pos.x;\n    if (distPX < u_boundSepRadius) {\n        separation += vec3(-1.0, 0.0, 0.0) / distPX;\n    }\n    float distNY = u_boundaries.y + pos.y;\n    if (distNY < u_boundSepRadius) {\n        separation += vec3(0.0, 1.0, 0.0) / distNY;\n    }\n    float distPY = u_boundaries.y - pos.y;\n    if (distPY < u_boundSepRadius) {\n        separation += vec3(0.0, -1.0, 0.0) / distPY;\n    }\n    float distNZ = u_boundaries.z + pos.z;\n    if (distNZ < u_boundSepRadius) {\n        separation += vec3(0.0, 0.0, 1.0) / distNZ;\n    }\n    float distPZ = u_boundaries.z - pos.z;\n    if (distPZ < u_boundSepRadius) {\n        separation += vec3(0.0, 0.0, -1.0) / distPZ;\n    }\n\n    if (separation == vec3(0.0)) return vec3(0.0);\n\n    vec3 desired = normalize(separation) * u_maxSpeed;\n    return limit(desired - vel, u_maxForce);\n}\n\nvoid calcNextPosAndVel(int currentIdx, float deltaTime, vec3 pos, vec3 vel, out vec3 nextPos, out vec3 nextVel) {\n    int trailNum = textureSize(u_positionTexture, 0).x;\n    vec3 separation = vec3(0.0);\n    vec3 alignment = vec3(0.0);\n    vec4 cohesion = vec4(0.0);\n    for (int i = 0; i < trailNum; i++) {\n        if (i == currentIdx) continue;\n        vec3 otherPos = texelFetch(u_positionTexture, ivec2(i, 0), 0).xyz;\n        float dist = distance(pos, otherPos);\n        if (dist < u_sepRadius) {\n            separation = normalize(pos - otherPos) / dist;\n        }\n        if (dist < u_aliRadius) {\n            vec3 otherVel = texelFetch(u_velocityTexture, ivec2(i, 0), 0).xyz;\n            alignment = otherVel;\n        }\n        if (dist < u_cohRadius) {\n            cohesion.xyz += otherPos;\n            cohesion.w += 1.0;\n        }\n    }\n\n    vec3 sepForce = vec3(0.0);\n    if (separation != vec3(0.0)) {\n        vec3 desired = normalize(separation) * u_maxSpeed;\n        sepForce = limit(desired - vel, u_maxForce);\n    }\n    vec3 aliForce = vec3(0.0);\n    if (alignment != vec3(0.0)) {\n        vec3 desired = normalize(alignment) * u_maxSpeed;\n        aliForce = limit(desired - vel, u_maxForce);\n    }\n    vec3 cohForce = vec3(0.0);\n    if (cohesion.w != 0.0) {\n        vec3 target = cohesion.xyz / cohesion.w;\n        vec3 desired = normalize(target - pos) * u_maxSpeed;\n        cohForce = limit(desired - vel, u_maxForce);\n    }\n\n    vec3 forceFromBoundaries = calcForceFromBoundaries(pos, vel);\n\n    vec3 force = u_sepWeight * sepForce + u_aliWeight * aliForce + u_cohWeight * cohForce + u_boundSepWeight * forceFromBoundaries;\n\n    nextVel = vel + u_deltaTime * force;\n    nextPos = pos + u_deltaTime * nextVel;\n\n    if (nextPos.x < -u_boundaries.x) {\n        nextPos.x = -u_boundaries.x;\n        if (nextVel.x < 0.0) nextVel.x *= -1.0; \n    }\n    if (nextPos.x > u_boundaries.x) {\n        nextPos.x = u_boundaries.x;\n        if (nextVel.x > 0.0) nextVel.x *= -1.0; \n    }\n    if (nextPos.y < -u_boundaries.y) {\n        nextPos.y = -u_boundaries.y;\n        if (nextVel.y < 0.0) nextVel.y *= -1.0; \n    }\n    if (nextPos.y > u_boundaries.y) {\n        nextPos.y = u_boundaries.y;\n        if (nextVel.y > 0.0) nextVel.y *= -1.0; \n    }\n    if (nextPos.z < -u_boundaries.z) {\n        nextPos.z = -u_boundaries.z; \n        if (nextVel.z < 0.0) nextVel.z *= -1.0; \n    }\n    if (nextPos.z > u_boundaries.z) {\n        nextPos.z = u_boundaries.z;\n        if (nextVel.z > 0.0) nextVel.z *= -1.0; \n    }\n\n}\n\nvoid main(void) {\n    ivec2 coord = ivec2(gl_FragCoord.xy);\n    vec3 nextPosition, nextVelocity, nextUp;\n    if (coord.y == 0) {\n        vec3 position = texelFetch(u_positionTexture, coord, 0).xyz;\n        vec3 velocity = texelFetch(u_velocityTexture, coord, 0).xyz;\n        vec3 up = texelFetch(u_upTexture, coord, 0).xyz;\n        calcNextPosAndVel(coord.x, u_deltaTime, position, velocity, nextPosition, nextVelocity);\n        vec3 front = normalize(nextVelocity);\n        vec3 right = normalize(cross(front, up));\n        nextUp = cross(right, front);\n    } else {\n        nextPosition = texelFetch(u_positionTexture, ivec2(coord.x, coord.y - 1), 0).xyz;\n        nextVelocity = texelFetch(u_velocityTexture, ivec2(coord.x, coord.y - 1), 0).xyz;\n        nextUp = texelFetch(u_upTexture, ivec2(coord.x, coord.y - 1), 0).xyz;\n    }\n    o_position = nextPosition;\n    o_velocity = nextVelocity;\n    o_up = nextUp;\n}",Z="#version 300 es\n\nprecision highp float;\n\nlayout (location = 0) in vec3 i_position;\nlayout (location = 1) in vec3 i_normal;\nlayout (location = 2) in int i_joint;\n\nout vec3 v_normal;\nout vec3 v_worldPos;\n\nuniform sampler2D u_positionTexture;\nuniform sampler2D u_velocityTexture;\nuniform sampler2D u_upTexture;\nuniform mat4 u_vpMatrix;\n\nmat4 getLookMat(vec3 front, vec3 up) {\n    vec3 z = -normalize(front);\n    vec3 y = up;\n    vec3 x = cross(z, y);\n\n    return mat4(\n        x.x, x.y, x.z, 0.0,\n        y.x, y.y, y.z, 0.0,\n        z.x, z.y, z.z, 0.0,\n        0.0, 0.0, 0.0, 1.0\n    );\n}\n\nvoid main(void) {\n    vec3 jointPosition = texelFetch(u_positionTexture, ivec2(gl_InstanceID, i_joint), 0).xyz;\n    vec3 velocity = texelFetch(u_velocityTexture, ivec2(gl_InstanceID, i_joint), 0).xyz;\n    vec3 up = texelFetch(u_upTexture, ivec2(gl_InstanceID, i_joint), 0).xyz;\n\n    mat4 lookMat = getLookMat(normalize(velocity), up);\n\n    mat4 modelMatrix =  mat4(\n        1.0, 0.0, 0.0, 0.0,\n        0.0, 1.0, 0.0, 0.0,\n        0.0, 0.0, 1.0, 0.0,\n        jointPosition.x, jointPosition.y, jointPosition.z, 1.0\n    ) * lookMat;\n\n    mat4 mvpMatrix = u_vpMatrix * modelMatrix;\n    v_worldPos = (modelMatrix * vec4(i_position, 1.0)).xyz;\n    v_normal = (lookMat * vec4(i_normal, 0.0)).xyz;\n    gl_Position = mvpMatrix * vec4(i_position, 1.0);\n}\n",k="#version 300 es\n\nprecision highp float;\n\nin vec3 v_worldPos;\nin vec3 v_normal;\n\nlayout (location = 0) out vec4 o_gBuffer0; // xyz: albedo, w: object type\nlayout (location = 1) out vec4 o_gBuffer1; // xyz: reflectance, w: reflect intensity\nlayout (location = 2) out vec3 o_gBuffer2; // xyz: world position\nlayout (location = 3) out vec3 o_gBuffer3; // xyz: world normal\n\nuniform vec3 u_albedo;\nuniform vec3 u_reflectance;\nuniform float u_refIntensity;\n\nstruct GBuffer {\n    vec3 albedo;\n    int type; // 0: bottom, 1: top, 2: left, 3: right, 4: far, 5: near, 6: trails\n    vec3 reflectance;\n    float refIntensity;\n    vec3 worldPosition;\n    vec3 worldNormal;\n};\n\nvoid setGBuffer(GBuffer gBuffer) {\n    o_gBuffer0 = vec4(gBuffer.albedo, float(gBuffer.type) + 0.5);\n    o_gBuffer1 = vec4(gBuffer.reflectance, gBuffer.refIntensity);\n    o_gBuffer2 = gBuffer.worldPosition;\n    o_gBuffer3 = gBuffer.worldNormal;\n}\nvoid main(void) {\n    vec3 normal = normalize(v_normal);\n\n    GBuffer gBuffer;\n    gBuffer.albedo = u_albedo;\n    gBuffer.type = 6;\n    gBuffer.reflectance = u_reflectance;\n    gBuffer.refIntensity = u_refIntensity;\n    gBuffer.worldPosition = v_worldPos;\n    gBuffer.worldNormal = normal;\n    setGBuffer(gBuffer);\n}",q={boundaries:"u_boundaries",randomSeed:"u_randomSeed"},K=["u_positionTexture","u_velocityTexture","u_upTexture","u_deltaTime","u_boundaries","u_maxSpeed","u_maxForce","u_sepRadius","u_aliRadius","u_cohRadius","u_sepWeight","u_aliWeight","u_cohWeight","u_boundSepRadius","u_boundSepWeight"],J={positionTexture:"u_positionTexture",velocityTexture:"u_velocityTexture",upTexture:"u_upTexture",vpMatrix:"u_vpMatrix",albedo:"u_albedo",reflectance:"u_reflectance",refIntensity:"u_refIntensity"},Q=function(){function e(e,t){var r,i=void 0===t?{}:t,o=i.trailNum,a=void 0===o?50:o,u=i.jointNum,s=void 0===u?200:u,l=i.angleSegment,h=void 0===l?16:l,p=i.trailRadius,m=void 0===p?1:p,d=i.boundaries,v=void 0===d?new n(100,50,100):d,x=i.maxSpeed,b=void 0===x?20:x,T=i.maxForce,y=void 0===T?10:T,w=i.sepRadius,E=void 0===w?10:w,R=i.aliRadius,A=void 0===R?15:R,F=i.cohRadius,M=void 0===F?20:F,S=i.sepWeight,P=void 0===S?5:S,z=i.aliWeight,B=void 0===z?1:z,U=i.cohWeight,N=void 0===U?1:U,D=i.boundSepRadius,O=void 0===D?10:D,I=i.boundSepWeight,L=void 0===I?10:I,C=i.albedo,j=void 0===C?new n(.5,.5,.5):C,X=i.reflectance,G=void 0===X?new n(.2,.2,.2):X,W=i.refIntensity,Q=void 0===W?1:W,$=i.startSecs,te=void 0===$?1:$;this.trailNum=a,this.boundaries=v,this.maxSpeed=b,this.maxForce=y,this.sepRadius=E,this.aliRadius=A,this.cohRadius=M,this.sepWeight=P,this.aliWeight=B,this.cohWeight=N,this.boundSepRadius=O,this.boundSepWeight=L,this.albedo=j,this.reflectance=G,this.refIntensity=Q,this.fpsTrigger=new V(60),r=function(e,t,r,n){var i=function(e,t,r){var n=2+(e-2)*t,i=new Int16Array(3*(2*t+2*t*(e-3))),o=new Float32Array(3*n),a=new Float32Array(3*n),u=new Int16Array(n),s=2*Math.PI/t,f=.5*e,c=0,l=0,h=0;c=re(o,c,0,0,0),l=re(a,l,0,0,-1),u[h++]=0;for(var p=0;p<e-2;p++)for(var m=0;m<t;m++){var d=m*s,_=r*oe(0,1,p<f-1?p/f:1-(p-f)/f),g=[_*Math.cos(d),_*Math.sin(d)];c=re(o,c,g[0],g[1],0),l=re(a,l,g[0]/_,g[1]/_,0),u[h++]=p+1}c=re(o,c,0,0,0),l=re(a,l,0,0,1),u[h++]=e-1;var v=0;for(m=0;m<t;m++){v=ne(i,v,0,m+1,(T=m!==t-1?m+1:0)+1)}var x=1;for(p=0;p<e-3;p++)for(m=0;m<t;m++){var b=p+1;v=ie(i,v,m+p*t+x,m+b*t+x,(T=m!==t-1?m+1:0)+p*t+x,T+b*t+x)}x+=t*(e-3);for(m=0;m<t;m++){var T;v=ne(i,v,n-1,(T=m!==t-1?m+1:0)+x,m+x)}return{indices:i,positions:o,normals:a,joints:u}}(t,r,n),o=c(e,i.positions),a=c(e,i.normals),u=c(e,i.joints),s=function(e,t){var r=e.createBuffer();return e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,r),e.bufferData(e.ELEMENT_ARRAY_BUFFER,t,e.STATIC_DRAW),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),r}(e,i.indices),f=e.createVertexArray();return e.bindVertexArray(f),e.bindBuffer(e.ARRAY_BUFFER,o),e.enableVertexAttribArray(0),e.vertexAttribPointer(0,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,a),e.enableVertexAttribArray(1),e.vertexAttribPointer(1,3,e.FLOAT,!1,0,0),e.bindBuffer(e.ARRAY_BUFFER,u),e.enableVertexAttribArray(2),e.vertexAttribIPointer(2,1,e.SHORT,0,0),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,s),e.bindVertexArray(null),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,null),e.bindBuffer(e.ARRAY_BUFFER,null),[f,i.indices.length]}(e,s,h,m),this.vao=r[0],this.vaoCount=r[1],this.trailsBuffer=new ee(e,a,s);var ae=f(e,g,e.VERTEX_SHADER),ue=f(e,H,e.FRAGMENT_SHADER);this.initializeProgram=new _(e,ae,ue,Object.values(q));var se=f(e,Y,e.FRAGMENT_SHADER);this.updateProgram=new _(e,ae,se,K);var fe=f(e,Z,e.VERTEX_SHADER),ce=f(e,k,e.FRAGMENT_SHADER);this.renderProgram=new _(e,fe,ce,Object.values(J)),this.initialize(e),this.update(e,te)}return e.prototype.initialize=function(e){e.bindFramebuffer(e.FRAMEBUFFER,this.trailsBuffer.writable.framebuffer),e.viewport(0,0,this.trailsBuffer.width,this.trailsBuffer.height),e.useProgram(this.initializeProgram.program),e.uniform3fv(this.initializeProgram.getUniform(q.boundaries),this.boundaries.toArray()),e.uniform1f(this.initializeProgram.getUniform(q.randomSeed),100*Math.random()),e.drawArrays(e.TRIANGLES,0,6),this.trailsBuffer.swap()},e.prototype.update=function(e,t){var r=this;this.fpsTrigger.addDeltaSecs(t,function(t){return r.step(e,t)})},e.prototype.step=function(e,t){e.bindFramebuffer(e.FRAMEBUFFER,this.trailsBuffer.writable.framebuffer),e.viewport(0,0,this.trailsBuffer.width,this.trailsBuffer.height),e.useProgram(this.updateProgram.program),p(e,0,this.trailsBuffer.readable.positionTexture,this.updateProgram.getUniform("u_positionTexture")),p(e,1,this.trailsBuffer.readable.velocityTexture,this.updateProgram.getUniform("u_velocityTexture")),p(e,2,this.trailsBuffer.readable.upTexture,this.updateProgram.getUniform("u_upTexture")),e.uniform1f(this.updateProgram.getUniform("u_deltaTime"),t),e.uniform3fv(this.updateProgram.getUniform("u_boundaries"),this.boundaries.toArray()),e.uniform1f(this.updateProgram.getUniform("u_maxSpeed"),this.maxSpeed),e.uniform1f(this.updateProgram.getUniform("u_maxForce"),this.maxForce),e.uniform1f(this.updateProgram.getUniform("u_sepRadius"),this.sepRadius),e.uniform1f(this.updateProgram.getUniform("u_aliRadius"),this.aliRadius),e.uniform1f(this.updateProgram.getUniform("u_cohRadius"),this.cohRadius),e.uniform1f(this.updateProgram.getUniform("u_sepWeight"),this.sepWeight),e.uniform1f(this.updateProgram.getUniform("u_aliWeight"),this.aliWeight),e.uniform1f(this.updateProgram.getUniform("u_cohWeight"),this.cohWeight),e.uniform1f(this.updateProgram.getUniform("u_boundSepRadius"),this.boundSepRadius),e.uniform1f(this.updateProgram.getUniform("u_boundSepWeight"),this.boundSepWeight),e.drawArrays(e.TRIANGLES,0,6),this.trailsBuffer.swap()},e.prototype.render=function(e,t){e.useProgram(this.renderProgram.program),p(e,0,this.trailsBuffer.readable.positionTexture,this.renderProgram.getUniform(J.positionTexture)),p(e,1,this.trailsBuffer.readable.velocityTexture,this.renderProgram.getUniform(J.velocityTexture)),p(e,2,this.trailsBuffer.readable.upTexture,this.renderProgram.getUniform(J.upTexture)),e.uniformMatrix4fv(this.renderProgram.getUniform(J.vpMatrix),!1,t.elements),e.uniform3fv(this.renderProgram.getUniform(J.albedo),this.albedo.toArray()),e.uniform3fv(this.renderProgram.getUniform(J.reflectance),this.reflectance.toArray()),e.uniform1f(this.renderProgram.getUniform(J.refIntensity),this.refIntensity),e.bindVertexArray(this.vao),e.drawElementsInstanced(e.TRIANGLES,this.vaoCount,e.UNSIGNED_SHORT,0,this.trailNum),e.bindVertexArray(null)},e.prototype.getPosition=function(e,t){var r=new Float32Array(4);return e.bindFramebuffer(e.FRAMEBUFFER,this.trailsBuffer.readable.framebuffer),e.readPixels(t,0,1,1,e.RGBA,e.FLOAT,r,0),new n(r[0],r[1],r[2])},e}();function $(e,t,r){return l(e,t,r,{internalFormat:e.RGBA32F,format:e.RGBA,type:e.FLOAT,parameteri:[[e.TEXTURE_MAG_FILTER,e.NEAREST],[e.TEXTURE_MIN_FILTER,e.NEAREST],[e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE],[e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE]]})}var ee=function(){function e(e,t,r){this.width=t,this.height=r,this._readable=new te(e,t,r),this._writable=new te(e,t,r)}return Object.defineProperty(e.prototype,"readable",{get:function(){return this._readable},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"writable",{get:function(){return this._writable},enumerable:!0,configurable:!0}),e.prototype.swap=function(){var e;e=[this._writable,this._readable],this._readable=e[0],this._writable=e[1]},e}(),te=function(e,t,r){this.width=t,this.height=r,this.positionTexture=$(e,t,r),this.velocityTexture=$(e,t,r),this.upTexture=$(e,t,r),this.framebuffer=e.createFramebuffer(),e.bindFramebuffer(e.FRAMEBUFFER,this.framebuffer),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,this.positionTexture,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT1,e.TEXTURE_2D,this.velocityTexture,0),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT2,e.TEXTURE_2D,this.upTexture,0),e.drawBuffers([e.COLOR_ATTACHMENT0,e.COLOR_ATTACHMENT1,e.COLOR_ATTACHMENT2]),e.bindFramebuffer(e.FRAMEBUFFER,null)};function re(e,t,r,n,i){return e[t++]=r,e[t++]=n,e[t++]=i,t}function ne(e,t,r,n,i){return e[t++]=r,e[t++]=n,e[t++]=i,t}function ie(e,t,r,n,i,o){return e[t]=r,e[t+1]=e[t+5]=n,e[t+2]=e[t+4]=i,e[t+3]=o,t+6}function oe(e,t,r){var n=function(e,t,r){return Math.max(Math.min(e,r),t)}((r-e)/(t-e),0,1);return n*n*(3-2*n)}var ae=function(){function e(){this.startMillisecs=0,this.lastObservedMillisecs=0}return e.prototype.start=function(){this.startMillisecs=performance.now(),this.lastObservedMillisecs=this.startMillisecs},e.prototype.getElapsedSecs=function(){return.001*(performance.now()-this.startMillisecs)},e.prototype.getElapsedDeltaSecs=function(){var e=this.lastObservedMillisecs;return this.lastObservedMillisecs=performance.now(),.001*(this.lastObservedMillisecs-e)},e}(),ue=function(){function e(e){var t=(void 0===e?{}:e).loopSecs,r=void 0===t?30:t;this.currentSecs=0,this.events=[],this.loopSecs=r}return e.prototype.add=function(e,t){this.events.push([e,t])},e.prototype.update=function(e){var t=this,r=this.currentSecs+e;this.events.forEach(function(n){n[0]>=t.currentSecs&&n[0]<r&&n[1](n[0],e)}),this.currentSecs=r,this.currentSecs>this.loopSecs&&(this.currentSecs%=this.loopSecs,this.events.forEach(function(r){r[0]<t.currentSecs&&r[1](r[0],e)}))},e}(),se=document.createElement("canvas");se.width=innerWidth,se.height=innerHeight,document.body.appendChild(se);var fe=se.getContext("webgl2");fe.getExtension("EXT_color_buffer_float");var ce=new ae,le=new o({aspect:se.width/se.height,vfov:60,near:.1,far:300}),he=new a(le,{orbitRadius:40,orbitHeight:-30,target:n.zero,speed:.1}),pe=new s(se.width,se.height),me=new d(fe,se.width,se.height),de=new b(fe,{lightSize:20,lightColor:new n(3,3,3)}),_e=new y(fe,se.width,se.height),ge=new E(fe,se.width,se.height),ve=new z(fe,se.width,se.height,{threshold:.2,intensity:.015}),xe=new N(fe,se.width,se.height,{focalDistance:5,focalRegion:10,nearTransition:10,farTransition:10}),be=new O(fe,{intensity:.005}),Te=new L(fe),ye=new j(fe),we=new A(fe),Ee=[be,ve],Re=[xe,ye],Ae=new n(50,50,50),Fe=new W(fe,Ae),Me=new Q(fe,{trailNum:1e3,jointNum:30,angleSegment:24,trailRadius:.5,boundaries:Ae,albedo:new n(.001,.001,.001),reflectance:new n(0,0,0),refIntensity:.5,sepRadius:5,aliRadius:8,cohRadius:8,maxForce:20,maxSpeed:20}),Se=new u(fe,le,Me,Ae),Pe=he,ze=new ue({loopSecs:120});ze.add(0,function(){Pe=he,le.vfov=90,xe.focalDistance=10,xe.focalRegion=10,xe.nearTransition=5,xe.farTransition=100}),ze.add(30,function(){Pe=Se,Se.reset(fe),le.vfov=60,xe.focalDistance=5,xe.focalRegion=10,xe.nearTransition=10,xe.farTransition=10}),fe.clearColor(0,0,0,1);var Be=null,Ue=function(){var e=ce.getElapsedSecs(),t=Math.min(.1,ce.getElapsedDeltaSecs());Me.update(fe,t),fe.enable(fe.DEPTH_TEST),fe.enable(fe.CULL_FACE),fe.bindFramebuffer(fe.FRAMEBUFFER,me.framebuffer),fe.viewport(0,0,me.width,me.height),fe.clear(fe.COLOR_BUFFER_BIT|fe.DEPTH_BUFFER_BIT),Me.render(fe,le.vpMatrix),Fe.render(fe,le,e),ze.update(t),Pe.update(fe,t),fe.disable(fe.DEPTH_TEST),fe.bindFramebuffer(fe.FRAMEBUFFER,_e.framebuffer),fe.viewport(0,0,_e.width,_e.height),de.apply(fe,me,le,Ae,e),_e.swap();var r={gBuffer:me,camera:le};Ee.forEach(function(e){e.apply(fe,_e,_e,r),_e.swap()}),Te.apply(fe,_e,ge,r),ge.swap(),Re.forEach(function(e){e.apply(fe,ge,ge,r),ge.swap()}),we.apply(fe,ge,pe,r),Be=requestAnimationFrame(Ue)};addEventListener("resize",function(){null!==Be&&(cancelAnimationFrame(Be),Be=null),se.width=innerWidth,se.height=innerHeight,le.aspect=se.width/se.height,me.resize(fe,se.width,se.height),pe.resize(fe,se.width,se.height),_e.resize(fe,se.width,se.height),ge.resize(fe,se.width,se.height),ve.resize(fe,se.width,se.height),xe.resize(fe,se.width,se.height),Be=requestAnimationFrame(Ue)}),ce.start(),Be=requestAnimationFrame(Ue)}]);